// Root build file - delegates to subprojects
// Each forge version module handles its own configuration

// ============================================
// CENTRALIZED MOD VERSION - Change here only!
// ============================================
ext {
    modVersion = '2.0.0'
    modGroupId = 'eu.avalanche7'
    modId = 'paradigm'
    modName = 'Paradigm'
    modLicense = 'CC-BY-NC-ND-4.0'
    modAuthors = 'Avalanche7CZ'
    modDescription = ''
}

subprojects {
    // Load version-specific properties for each module BEFORE evaluation
    def versionName = name.replace('forge-', '')
    def versionPropsFile = rootProject.file("gradle/versions/forge-${versionName}.gradle.properties")

    if (versionPropsFile.exists()) {
        // Load properties file
        Properties props = new Properties()
        versionPropsFile.withInputStream { stream ->
            props.load(stream)
        }

        // Set properties on the project's ext before configuration
        props.each { key, value ->
            // Skip gradle-specific properties and mod version (use root version instead)
            if (!key.toString().startsWith('org.gradle') && key.toString() != 'mod_version') {
                project.ext.set(key.toString(), value.toString())
            }
        }

        // Override with centralized mod properties
        project.ext.mod_version = rootProject.ext.modVersion
        project.ext.mod_group_id = rootProject.ext.modGroupId
        project.ext.mod_id = rootProject.ext.modId
        project.ext.mod_name = rootProject.ext.modName
        project.ext.mod_license = rootProject.ext.modLicense
        project.ext.mod_authors = rootProject.ext.modAuthors
        project.ext.mod_description = rootProject.ext.modDescription

        println "Loaded properties for ${name}: minecraft=${project.ext.minecraft_version}, forge=${project.ext.forge_version}, mod_version=${project.ext.mod_version}"
    } else {
        println "WARNING: No properties file found for ${name} at ${versionPropsFile}"
    }
}

// Default task delegates to all subprojects
defaultTasks 'build'

// Automatically collect built jars from subprojects into artifacts/jars
subprojects { proj ->
    // Configure after project evaluation to ensure `jar` task exists
    proj.afterEvaluate {
        try {
            def jarTasks = proj.tasks.matching { it.name == 'jar' }
            jarTasks.configureEach { jarTask ->
                jarTask.doLast {
                    try {
                        def artifactsDir = rootProject.file('artifacts/jars')
                        if (!artifactsDir.exists()) {
                            artifactsDir.mkdirs()
                        }
                        // Resolve archive file (Gradle 6+/7+ API)
                        def archiveFile = null
                        try {
                            archiveFile = jarTask.archiveFile.get().asFile
                        } catch (Exception e) {
                            // fallback for older Gradle API
                            archiveFile = new File(proj.buildDir, "libs/${proj.name}-${proj.version}.jar")
                        }
                        if (archiveFile != null && archiveFile.exists()) {
                            def dest = new File(artifactsDir, archiveFile.getName())
                            project.logger.lifecycle("Copying ${archiveFile} -> ${dest}")
                            dest.withOutputStream { os ->
                                archiveFile.withInputStream { is -> os << is }
                            }
                        } else {
                            project.logger.lifecycle("No jar found to copy for project ${proj.name} (looked for: ${archiveFile})")
                        }
                    } catch (Exception ex) {
                        project.logger.warn("Failed to copy jar for project ${proj.name}: ${ex}")
                    }
                }
            }
        } catch (Exception e) {
            proj.logger.warn("Artifact-collector: failed to attach to jar task for project ${proj.name}: ${e}")
        }
    }
}
